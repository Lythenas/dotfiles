#! /bin/sh

# TODO only start those if they are not already running
# maybe move to systemd --user
killall sxhkd
SXHKD_SHELL=/usr/bin/bash sxhkd &

~/.config/bspwm/bars.sh &

killall picom
picom &
killall dunst
dunst &

feh --no-fehbg --bg-fill ~/.config/bspwm/wallpaper.jpg &

# Start other apps
pgrep syncthing-gtk || syncthing-gtk &
pgrep nm-applet || nm-applet --sm-disable &

# Fix gnome apps and service
dbus-update-activation-environment \
  --systemd DBUS_SESSION_BUS_ADDRESS DISPLAY XAUTHORITY

# Autolock setup
killall xidlehook
xidlehook \
  --not-when-fullscreen \
  --socket ~/.xidlehook.socket \
  --timer 270 \
    'for m in $(xrandr | grep -E " connected (primary )?[1-9]+" | sed -e "s/\([A-Z0-9]\+\) connected.*/\1/"); do xrandr --output $m --brightness 0.5; done' \
    'for m in $(xrandr | grep -E " connected (primary )?[1-9]+" | sed -e "s/\([A-Z0-9]\+\) connected.*/\1/"); do xrandr --output $m --brightness 1; done' \
  --timer 30 \
    'for m in $(xrandr | grep -E " connected (primary )?[1-9]+" | sed -e "s/\([A-Z0-9]\+\) connected.*/\1/"); do xrandr --output $m --brightness 1; done; ~/bin/lock' \
    '' \
  --timer 3600 \
    'systemctl suspend' \
    '' &

mons -a -x ~/.config/bspwm/handle-monitor-change.sh


# bspwm setup
bspc monitor eDP1 -d 1 2 3 4 5 6
bspc monitor HDMI2 -d 7 8 9 0

bspc config border_width         2
bspc config window_gap           0

bspc config normal_border_color '#282828'
bspc config active_border_color '#282828'
bspc config focused_border_color '#ab4642'

bspc config split_ratio          0.52
bspc config borderless_monocle   true
bspc config gapless_monocle      true

bspc config automatic_scheme longest_side

bspc rule -a Gimp desktop='^8' state=floating follow=on
bspc rule -a firefox desktop='^1'
bspc rule -a Thunderbird desktop='^10'
bspc rule -a Spotify desktop='^9'
bspc rule -a mplayer2 state=floating
bspc rule -a Kupfer.py focus=on
bspc rule -a Screenkey manage=off
